(function(c){var e=function(){var c=function(a){var b={data:[],heatmap:a};this.max=1;this.get=function(a){return b[a]};this.set=function(a,d){b[a]=d}};c.prototype={addDataPoint:function(a,b){if(!(0>a||0>b)){var g=this.get("heatmap"),d=this.get("data");d[a]||(d[a]=[]);d[a][b]||(d[a][b]=0);d[a][b]+=3>arguments.length?1:arguments[2];this.set("data",d);this.max<d[a][b]?(g.get("actx").clearRect(0,0,g.get("width"),g.get("height")),this.setDataSet({max:d[a][b],data:d},!0)):g.drawAlpha(a,b,d[a][b],!0)}},
setDataSet:function(a,b){var g=this.get("heatmap"),d=[],f=a.data,c=f.length;g.clear();this.max=a.max;g.get("legend")&&g.get("legend").update(a.max);if(null!=b&&b)for(var h in f){if(void 0!==h)for(var e in f[h])void 0!==e&&g.drawAlpha(h,e,f[h][e],!1)}else for(;c--;)h=f[c],g.drawAlpha(h.x,h.y,h.count,!1),d[h.x]||(d[h.x]=[]),d[h.x][h.y]||(d[h.x][h.y]=0),d[h.x][h.y]=h.count;g.colorize();this.set("data",f)},exportDataSet:function(){var a=this.get("data"),b=[],g;for(g in a)if(void 0!==g)for(var d in a[g])void 0!==
d&&b.push({x:parseInt(g,10),y:parseInt(d,10),count:a[g][d]});return{max:this.max,data:b}},generateRandomDataSet:function(a){var b=this.get("heatmap"),g=b.get("width"),b=b.get("height"),d={},f=Math.floor(1E3*Math.random()+1);d.max=f;for(var c=[];a--;)c.push({x:Math.floor(Math.random()*g+1),y:Math.floor(Math.random()*b+1),count:Math.floor(Math.random()*f+1)});d.data=c;this.setDataSet(d)}};var e=function(a){this.config=a;var b={element:null,labelsEl:null,gradientCfg:null,ctx:null};this.get=function(a){return b[a]};
this.set=function(a,d){b[a]=d};this.init()};e.prototype={init:function(){var a=this.config,b=a.title||"Legend",g=a.position,d=a.offset||10,a=document.createElement("ul"),f="";this.processGradientObject();f=-1<g.indexOf("t")?f+("top:"+d+"px;"):f+("bottom:"+d+"px;");f=-1<g.indexOf("l")?f+("left:"+d+"px;"):f+("right:"+d+"px;");g=document.createElement("div");g.style.cssText="border-radius:5px;position:absolute;"+f+"font-family:Helvetica; width:256px;z-index:10000000000; background:rgba(255,255,255,1);padding:10px;border:1px solid black;margin:0;";
g.innerHTML="<h3 style='padding:0;margin:0;text-align:center;font-size:16px;'>"+b+"</h3>";a.style.cssText="position:relative;font-size:12px;display:block;list-style:none;list-style-type:none;margin:0;height:15px;";b=document.createElement("div");b.style.cssText=["position:relative;display:block;width:256px;height:15px;border-bottom:1px solid black; background-image:url(",this.createGradientImage(),");"].join("");g.appendChild(a);g.appendChild(b);this.set("element",g);this.set("labelsEl",a);this.update(1)},
processGradientObject:function(){var a=this.config.gradient,b=[],g;for(g in a)a.hasOwnProperty(g)&&b.push({stop:g,value:a[g]});b.sort(function(a,b){return a.stop-b.stop});b.unshift({stop:0,value:"rgba(0,0,0,0)"});this.set("gradientArr",b)},createGradientImage:function(){var a=this.get("gradientArr"),b=a.length,g=document.createElement("canvas"),d=g.getContext("2d"),f;g.width="256";g.height="15";f=d.createLinearGradient(0,5,256,10);for(var c=0;c<b;c++)f.addColorStop(1/(b-1)*c,a[c].value);d.fillStyle=
f;d.fillRect(0,5,256,10);d.strokeStyle="black";d.beginPath();for(c=0;c<b;c++)d.moveTo((256*1/(b-1)*c>>0)+0.5,0),d.lineTo((256*1/(b-1)*c>>0)+0.5,0==c?15:5);d.moveTo(255.5,0);d.lineTo(255.5,15);d.moveTo(255.5,4.5);d.lineTo(0,4.5);d.stroke();this.set("ctx",d);return g.toDataURL()},getElement:function(){return this.get("element")},update:function(a){for(var b=this.get("gradientArr"),g=this.get("ctx"),d=this.get("labelsEl"),f,c="",e,k=0;k<b.length;k++)f=a*b[k].stop>>0,e=g.measureText(f).width/2>>0,0==
k&&(e=0),k==b.length-1&&(e*=2),c+='<li style="position:absolute;left:'+(((256*1/(b.length-1)*k||0)>>0)-e+0.5)+'px">'+f+"</li>";d.innerHTML=c}};var m=function(a){var b={radius:40,element:{},canvas:{},acanvas:{},ctx:{},actx:{},legend:null,visible:!0,width:0,height:0,max:!1,gradient:!1,opacity:180,premultiplyAlpha:!1,bounds:{l:1E3,r:0,t:1E3,b:0},debug:!1};this.store=new c(this);this.get=function(a){return b[a]};this.set=function(a,d){b[a]=d};this.configure(a);this.init()};m.prototype={configure:function(a){this.set("radius",
a.radius||40);this.set("element",a.element instanceof Object?a.element:document.getElementById(a.element));this.set("visible",null!=a.visible?a.visible:!0);this.set("max",a.max||!1);this.set("gradient",a.gradient||{"0.45":"rgb(0,0,255)","0.55":"rgb(0,255,255)","0.65":"rgb(0,255,0)","0.95":"yellow",1:"rgb(255,0,0)"});this.set("opacity",parseInt(255/(100/a.opacity),10)||180);this.set("width",a.width||0);this.set("height",a.height||0);this.set("debug",a.debug);a.legend&&(a=a.legend,a.gradient=this.get("gradient"),
this.set("legend",new e(a)))},resize:function(){var a=this.get("element"),b=this.get("canvas"),g=this.get("acanvas");b.width=g.width=this.get("width")||a.style.width.replace(/px/,"")||this.getWidth(a);this.set("width",b.width);b.height=g.height=this.get("height")||a.style.height.replace(/px/,"")||this.getHeight(a);this.set("height",b.height)},init:function(){var a=document.createElement("canvas"),b=document.createElement("canvas"),g=a.getContext("2d"),d=b.getContext("2d"),c=this.get("element");this.initColorPalette();
this.set("canvas",a);this.set("ctx",g);this.set("acanvas",b);this.set("actx",d);this.resize();a.style.cssText=b.style.cssText="position:absolute;top:0;left:0;z-index:10000000;";this.get("visible")||(a.style.display="none");c.appendChild(a);this.get("legend")&&c.appendChild(this.get("legend").getElement());this.get("debug")&&document.body.appendChild(b);d.shadowOffsetX=15E3;d.shadowOffsetY=15E3;d.shadowBlur=15},initColorPalette:function(){var a=document.createElement("canvas"),b=this.get("gradient"),
g,d;a.width="1";a.height="256";a=a.getContext("2d");g=a.createLinearGradient(0,0,1,256);d=a.getImageData(0,0,1,1);d.data[0]=d.data[3]=64;d.data[1]=d.data[2]=0;a.putImageData(d,0,0);d=a.getImageData(0,0,1,1);this.set("premultiplyAlpha",60>d.data[0]||70<d.data[0]);for(var c in b)g.addColorStop(c,b[c]);a.fillStyle=g;a.fillRect(0,0,1,256);this.set("gradient",a.getImageData(0,0,1,256).data)},getWidth:function(a){var b=a.offsetWidth;a.style.paddingLeft&&(b+=a.style.paddingLeft);a.style.paddingRight&&(b+=
a.style.paddingRight);return b},getHeight:function(a){var b=a.offsetHeight;a.style.paddingTop&&(b+=a.style.paddingTop);a.style.paddingBottom&&(b+=a.style.paddingBottom);return b},colorize:function(a,b){var c=this.get("width"),d=this.get("radius"),f=this.get("height"),e=this.get("actx"),h=this.get("ctx"),k=3*d,d=this.get("premultiplyAlpha"),m=this.get("gradient"),q=this.get("opacity"),n=this.get("bounds"),p,l,r;null!=a&&null!=b?(a+k>c&&(a=c-k),0>a&&(a=0),0>b&&(b=0),b+k>f&&(b=f-k),p=a,c=b,l=a+k,f=b+
k):(p=0>n.l?0:n.l,l=n.r>c?c:n.r,c=0>n.t?0:n.t,f=n.b>f?f:n.b);e=e.getImageData(p,c,l-p,f-c);f=e.data;k=f.length;for(l=3;l<k;l+=4)if(r=f[l],n=4*r)r=r<q?r:q,f[l-3]=m[n],f[l-2]=m[n+1],f[l-1]=m[n+2],d&&(f[l-3]/=255/r,f[l-2]/=255/r,f[l-1]/=255/r),f[l]=r;e.data=f;h.putImageData(e,p,c)},drawAlpha:function(a,b,c,d){var f=this.get("radius"),e=this.get("actx");this.get("max");var h=this.get("bounds"),k=a-1.5*f>>0,m=b-1.5*f>>0,p=a+1.5*f>>0,n=b+1.5*f>>0;e.shadowColor="rgba(0,0,0,"+(c?c/this.store.max:"0.1")+")";
e.shadowOffsetX=15E3;e.shadowOffsetY=15E3;e.shadowBlur=15;e.beginPath();e.arc(a-15E3,b-15E3,f,0,2*Math.PI,!0);e.closePath();e.fill();d?this.colorize(k,m):(k<h.l&&(h.l=k),m<h.t&&(h.t=m),p>h.r&&(h.r=p),n>h.b&&(h.b=n))},toggleDisplay:function(){var a=this.get("visible");this.get("canvas").style.display=a?"none":"block";this.set("visible",!a)},getImageData:function(){return this.get("canvas").toDataURL()},clear:function(){var a=this.get("width"),b=this.get("height");this.store.set("data",[]);this.get("ctx").clearRect(0,
0,a,b);this.get("actx").clearRect(0,0,a,b)},cleanup:function(){this.get("element").removeChild(this.get("canvas"))}};return{create:function(a){return new m(a)},util:{mousePosition:function(a){var b,c;a.layerX?(b=a.layerX,c=a.layerY):a.offsetX&&(b=a.offsetX,c=a.offsetY);if("undefined"!=typeof b)return[b,c]}}}}();c.h337=c.heatmapFactory=e})(window);OpenLayers.Layer.Heatmap=OpenLayers.Class(OpenLayers.Layer,{isBaseLayer:!1,heatmap:null,mapLayer:null,tmpData:{},initialize:function(c,e,q,p,m){var a=document.createElement("div");OpenLayers.Layer.prototype.initialize.apply(this,[c,m]);a.style.cssText="position:absolute;width:"+e.size.w+"px;height:"+e.size.h+"px;";this.div.appendChild(a);p.element=a;this.mapLayer=q;this.map=e;this.heatmap=h337.create(p);c=function(){this.tmpData.max&&this.updateLayer()};e.events.register("zoomend",this,c);e.events.register("moveend",
this,c)},updateLayer:function(){var c=this.getPixelOffset(),e=this.heatmap.get("element");e.style.top=(0<c.y?"-"+c.y:Math.abs(c.y))+"px";e.style.left=(0<c.x?"-"+c.x:Math.abs(c.x))+"px";this.setDataSet(this.tmpData)},getPixelOffset:function(){var c=this.mapLayer.map.layerContainerOrigin,c=new OpenLayers.LonLat(c.lon,c.lat),c=this.mapLayer.getViewPortPxFromLonLat(c),e=this.mapLayer.map.center,e=new OpenLayers.LonLat(e.lon,e.lat),e=this.mapLayer.getViewPortPxFromLonLat(e);return{x:c.x-e.x,y:c.y-e.y}},
setDataSet:function(c){var e={},q=c.data,p=q.length,m,a;e.max=c.max;for(e.data=[];p--;)m=q[p],a=m.lonlat.clone().transform(this.projection,this.map.getProjectionObject()),(a=this.roundPixels(this.getViewPortPxFromLonLat(a)))&&e.data.push({x:a.x,y:a.y,count:m.count});this.tmpData=c;this.heatmap.store.setDataSet(e)},roundPixels:function(c){if(0>c.x||0>c.y)return!1;c.x>>=0;c.y>>=0;return c},addDataPoint:function(c){var e=this.roundPixels(this.mapLayer.getViewPortPxFromLonLat(c)),q={lonlat:c};2==arguments.length&&
(q.count=arguments[1]);this.tmpData.data.push(q);e&&(e=[e.x,e.y],2==arguments.length&&e.push(arguments[1]),this.heatmap.store.addDataPoint.apply(this.heatmap.store,e))},toggle:function(){this.heatmap.toggleDisplay()},destroy:function(){OpenLayers.Layer.Grid.prototype.destroy.apply(this,arguments)},CLASS_NAME:"OpenLayers.Layer.Heatmap"});
